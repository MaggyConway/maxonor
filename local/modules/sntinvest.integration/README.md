# Интеграция с очередью REBBITMQ

## Общая схема
1. 1С в формате XML или CSV, в зависимости от типа данных разный формат файла, выгружает на сайт. Сайт по старым обменом сохраняет во внутренние таблицы 
2. По событию добавления/изменения  пользователей на сайте данные формируются в JSON и отправляются в RebbitMq в соответсвующую выгрузку 
3. По событию добавления/изменения  товара на сайте данные формируются в JSON и отправляются в RebbitMq в соответсвующую выгрузку 
4. При получении  файла взаиморасчётов в очередь обработки файлов на сайте данные формируются в JSON и отправляются в RebbitMq в соответсвующую выгрузку 
5. Получения на стороне б24 
5.1. Получение пользователей из RebbitMq из соответсвующую очереди и сохранения их как компании
5.2. Получение товаров из RebbitMq из соответсвующую очереди и сохранения их
5.3. Получение взаиморасчётов из RebbitMq из соответсвующую очереди и сохранения их Сделки и заказы
6. Приложение Laravel  из RebbitMq из соответствующей очереди забирает товары и сохраняет их в Elastic

## Схема отправки
Данные формируются в JSON и разу отправляются в Exchange. Из Exchange уже в созданные очереди. Поэтому важно сперва создать очередь у приёмника, а потом уже отправлять данные. Если не будет осознанно ни одной очереди в Exchange, то данные пропадут.

## Схема получения
При первом подключении к RebbitMq если не будет создано очереди, она создаться. При каждом подключении к очереди будут забираться все доступные записи или если есть ограничение, то сколько задано. Например, в очереди висит 1003 элементов, а у сущности стоит ограничение 100, тогда при каждом вызове команды будет забираться 100 элементов, а последнее выполнение команды будет 3, после элементы будут забираться только  когда появятся в очереди.  Скрипт получение запускается по команде

```sh
php local/modules/sntinvest.integration/run exchange:[type]
```
или

```sh
cd local/modules/sntinvest.integration
php run exchange:[type]
```
Где [type] - это необходимая сущность. 

## Доступные команды
### Выгрузка пользователей
```sh
php run exchange:user
```
### Выгрузка товаров
```sh
php run exchange:product
```
### Выгрузка взаиморасчётов
```sh
php run exchange:mutualsettlements
```

## Структура модуля
* bootstrap - автоматизированное подключение
* config - внедрение зависимостей, список объектов и способ их создания
* install - для установки модуля
* lang - языковые файлы
* lib - код модуля 
* vendor - php библиотеки 



